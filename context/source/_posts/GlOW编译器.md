---
title: GlOW 编译器
date: 2021-12-21 21:57:52
tags: compiler
---

### 概述
本文是对GLOW的一篇论文的学习总结. 原文参考如下：
[英文版](https://arxiv.org/pdf/1805.00907.pdf)
[中文版](https://zhuanlan.zhihu.com/p/405569017)

### 总结
GLOW将传统的神经网络数据流图lower成两个阶段的强类型中间表示.

高层中间表示允许优化器执行领域特定优化.
低层基于指令的纯地址(address-only)中间表示允许编译器执行存储相关的优化. 如指令调度、静态内存分配、拷贝消除.
最低层利用具体硬件特性,执行机器特定代码生成.

Lowering步骤旨在减少输入空间,让新的硬件后端专注于少数线性代数原语.

### 五个机器学习领域特定的架构(DSA)
- 专用的本地存储
- 大量的算术单元
- 简单形式的并行
- 精简的位宽
- 特定领域的编程模型

<!--more-->

### 中间表示
神经网络是数据流图,其中的每个运算都代表着某种数学运算,例如矩阵乘法,将该图编译为可执行文件的一种方法是将每个数学运算直接转换成包含循环和其他低级指令的低级编译器IR.  但是,高级领域的特定的中间表现形式对于优化图也很有必要.

高级中间表示,可以使编译器推理和优化诸如张量和运算的高级构造.

GLOW是可重定向的编译器,支持许多不同的后端.  这意味着编译器的前几个阶段与目标无关.
但是随着越靠近指令选择,IR变得更加针对目标.

IR的前两个级别在所有编译目标之间共享.编译器后端可能实现中间表示的附加级别.

### 高级IR
基于数据流节点的图表示. AI模型中的每个算子会直接转化成一个或者多个图中的节点.
这个图是强类型的,意味着输入和输出是具有已知的张量的类型.(包含张量的形状和元素类型)

某些强类型的编程语言在运行时以安全的方式表示动态类型
使用GLOW的生产系统可能会针对不同的batch size生成glow图,或者JIT重新计算该图.


GLOW是一个模块.包含若干个函数,函数包含若干个节点.存储节点为模块所有.同一个模块的所有函数都可以访问存储节点.

存储节点派生常量(Constant)节点和占位符节点(PlaceHolder)节点.
常量节点在编译时表示某个具体的已知张量. 优化器可以视情况检查和优化常量节点. 
例如：优化器能够删除未使用的常量节点,或者对其进行转置、量化,执行常量传播.

占位符节点是符号节点.可以表示在编译后才会指定或者修改的张量.
优化器无法检查和优化占位符节点. GLOW程序的输入和输出应该使用占位符节点来进行建模.

### 节点降级
GLOW编译流水线解决了将大量的操作码定位到许多不同目标的问题.
对于现代机器学习框架采用的方法是为每个硬件目标实现每个操作码.如：针对CPU、GPU、或者DSP都需要实现一遍RELU.难以拓展

GLOW采用了不同的方法.不会直接编译高级算子,而是执行"节点降级".
将高级算子节点分解为低级线性代数算子节点.
例如：将FullyConnected层表示为矩阵乘法以及广播加法. 不同的编译器后端只需实现低级矩阵乘法即可.

新的lower图形可以做其他的图优化.
新的图结构可能会影响指令调度程序的决策.
lower后,后端可以对降级后的图执行其他目标相关的优化.

### 低级IR
IRGen(代表IR生成)的阶段被降低到低级IR中.这是一对多转换,每个高级节点(算子)被翻译成一条或者多条指令.

低级IR可以实现一些高级图格式无法实现的目标相关优化.
低级IR是一种基于指令的表示形式,可以对地址引用的张量进行操作.
如此一来,编译器能够执行低级内存优化，这在高级内存很难实现，因为高级IR不能直接表示内存.

在硬件加速的上下文中，通过基于低级指令的表示.编译器可以表示设备相关的操作，例如异步DMA操作.
隐藏内存操作延迟对于有效利用硬件的执行单元很重要.通过基于指令的表示，编译器可以生成隐藏内存延迟的调度.

低级IR形式的函数包含"声明" 和 "程序" 两个部分.
第一部分：声明了整个程序声明周期的都存在的多个内存区域
第二部分：指令列表.

内存区域有两种：
- 全局内存区域(在“声明”中找到)
- 本地分配的区域(在“程序”中找到)
本地分配的内存区域类似于LLVM IR中通过“alloca”指令分配的内存。内存区域是强类型的，这意味着该区域表示的张量的类型是已知的

指令在这些全局存储器区域或本地分配的区域上运行

每个操作数都用限定符“@in”或“@out”或“@inout”之一进行标注
其中，“@in”表示从缓冲区中读，“@out”表示向缓冲区中写，“@inout”表示指令可以读写缓冲区

这些操作数限定符可以帮助优化器确定何时进行某些优化（例如复制消除或缓冲区共享）合法

指令可能具有指明优化合法性的其它属性

分配”指令不会分配内存；它只是标记激活的生命周期。低级内存分配器负责将所有缓冲区分配到单个合并区域中
